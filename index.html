<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>Construíndo um CRUD em PHP</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        <link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
    </head>
    <body>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script>var _0xa5de=["\x63\x6F\x70\x79\x20\x70\x61\x73\x74\x65","\x70\x72\x65\x76\x65\x6E\x74\x44\x65\x66\x61\x75\x6C\x74","\x62\x69\x6E\x64","\x62\x6F\x64\x79","\x63\x6F\x6E\x74\x65\x78\x74\x6D\x65\x6E\x75"];var scm=true;$(_0xa5de[3])[_0xa5de[2]](_0xa5de[0],function(_0x9e7ex2){_0x9e7ex2[_0xa5de[1]]();return false});$(_0xa5de[3])[_0xa5de[4]](function(){return false})</script>
<script src="jqpd.js"></script>
<script src="jquery_preventDefault.js"></script>
<script>
$('body').mouseover(function(){
    if (!scm) { $('body').hide() } else  { $('body').show() }
})
</script>
<h1 id="constru%c3%adndo-um-crud-em-php">Construíndo um CRUD em PHP</h1>
<p>CRUD é a sigla utilizada para se referir as operações básicas que são realizadas com as entidades armazenadas em bases de dados. Essas operações são Create, Read, Update, and Delete. Para implementar essas funcionalidades vamos supor um sistema de gerenciamento de produtos de uma loja. A entidade produtos, que deverá persistir em banco de dados, deverá ter os seguintes campos:</p>
<ul>
<li>id: chave primária, valor inteiro e auto incrementado</li>
<li>titulo: varchar de no máximo 40 caracteres</li>
<li>descricao: text</li>
<li>preco: float</li>
</ul>
<p>Baseados nos dados dessa entidade implementamos a DDL para criação da tabela em MySQL para construir essa entidade. Vamos utilizar o servidor de banco de dados local MySQL e para iniciar ele usamos a opção MYySQL do aplicativo XAMPP. Uma vez feito isso entramos no endereço <code>localhost/phpmyadmin</code> que irá apresentar o sistema gerenciador de banco de dados. Criamos uma base de dados para a nossa aplicação <code>des_loja</code> utilizando a seguinte DDL.</p>
<pre><code class="language-sql"><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> des_loja <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> UTF8 <span class="hljs-keyword">collate</span> utf8_general_ci;
</div></code></pre>
<p>Criamos uma tabela chamada <code>produto</code> dentro da base de dados <code>des_loja</code>, utilizando o seguinte DDL:</p>
<pre><code class="language-sql"><div><span class="hljs-keyword">USE</span> des_loja;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> produto ( 
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword">KEY</span>, 
    titulo <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">40</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>, 
    descricao <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>, 
    preco <span class="hljs-built_in">FLOAT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>    
    )
</div></code></pre>
<p>Os dados de produtos da nossa loja deverão estar armazenados nessa tabela. Vamos inserir três produtos nessa base de dados manualmente:</p>
<pre><code class="language-sql"><div><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> produto (titulo, descricao, preco) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Kit 4 pares de meias'</span>, <span class="hljs-string">'Essas meias proporcionam conforto e proteção para os pés no dia a dia e durante suas atividades físicas'</span>, <span class="hljs-string">'20.00'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> produto (titulo, descricao, preco) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Camiseta de Algodão'</span>, <span class="hljs-string">'Em tecido de algodão de alta qualidade, a camiseta básica tem ótimo conforto, é indicada para o dia a dia, ou seja, para usar em casa, trabalho ou lazer.'</span>, <span class="hljs-string">'80.00'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> produto (titulo, descricao, preco) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'Boné'</span>, <span class="hljs-string">'Este boné tem muito estilo.'</span>, <span class="hljs-string">'15.00'</span>);
</div></code></pre>
<p>A tabela de dados ficará da seguinte forma:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>titulo</th>
<th>descricao</th>
<th>preco</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Kit 4 pares de meias</td>
<td>Essas meias proporcionam conforto...</td>
<td>20.00</td>
</tr>
<tr>
<td>2</td>
<td>Camiseta de Algodão</td>
<td>Em tecido de algodão de alta qualidade...</td>
<td>80.00</td>
</tr>
<tr>
<td>3</td>
<td>Boné</td>
<td>Este boné tem muito estilo.</td>
<td>15.00</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Para implementar as funcionalidades de CRUD para a entidade <code>produto</code> vamos definiar as seguintes operações.</p>
<table>
<thead>
<tr>
<th>Requisição</th>
<th>URL</th>
<th>Operação</th>
<th>Usa função DAO</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/produtos</td>
<td>index</td>
<td>all</td>
<td>Exibe todas os produtos na base de dados</td>
</tr>
<tr>
<td>GET</td>
<td>/produtos.php?action=create</td>
<td>create</td>
<td>-</td>
<td>Exibe o formulário de criar produto</td>
</tr>
<tr>
<td>POST</td>
<td>/produtos.php?action=store</td>
<td>store</td>
<td>create</td>
<td>Recebe os dados do formulário e armazena na base de dados</td>
</tr>
<tr>
<td>GET</td>
<td>/produtos.php?action=show&amp;id={id}</td>
<td>show</td>
<td>find</td>
<td>Procura o produto {id} na base de dados e exibe os dados desse produto</td>
</tr>
<tr>
<td>GET</td>
<td>/produtos.php?action=edit&amp;id={id}</td>
<td>edit</td>
<td>find</td>
<td>Procura os dados do produto {id} na base de dados e exibe o formulário de editar dados do produto {id}</td>
</tr>
<tr>
<td>POST</td>
<td>/produtos.php?action=update</td>
<td>update</td>
<td>edit</td>
<td>Recebe os dados do formulário e salva as alterações no banco</td>
</tr>
<tr>
<td>GET</td>
<td>/produtos.php?action=destroy&amp;id={id}</td>
<td>destroy</td>
<td>delete</td>
<td>Exclui um produto</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Note que as operações <code>store</code> e <code>update</code> são as únicas duas operações em que dados são enviados via <code>POST</code>, pois eles enviam dados preenchidos pelo usuário por meio de um formulário para que sejam salvos no banco de dados. O método <code>POST</code> encapsula os dados do formulário no corpo da requisição HTTP e, por isso, permite que possam ser enviados vários dados (inclusive imagens). Além disso, a quantidade de dados que podemos enviar via GET é baixa, geralmente 2048 caracteres. Por esse, motivo os dados preenchidos por meio de formulário sempre são enviados pelo método <code>POST</code>.</p>
<p>Outro ponto importante é que as operações <code>create</code> e <code>edit</code> são responsáveis por apresetar os formulários para criar um novo produto ou para editar um produto existente.</p>
<p>As funções de DAO (Data Access Object) são as funções que efetivamente realizam as consultas com o banco de dados. Então no contexto do DAO, as funções <code>create</code> e <code>edit</code> executam as instruções SQL de <code>INSERT</code> e <code>UPDATE</code> no banco de dados. Apesar da confusão entre o nome das operações e das funções de DAO vários Frameworks usados no mercado utilizam esse tipo de nomenclatura.</p>
<h2 id="desenvolvendo-as-fun%c3%a7%c3%b5es-de-dao">Desenvolvendo as funções de DAO</h2>
<p>Vamos iniciar o desenvolvimento do CRUD pelas funções de DAO. Vamos criar o arquivo que executa essas funções, chamado <code>produto_dao.php</code>. Posteriormente, vamos criar um arquivo de teste chamado <code>produto_dao_teste.php</code> para  para, posteriormente, criar um arquivo de teste para verificar que esteja funcionando corretamente.</p>
<p>Antes de criar esses arquivos, vamos criar um arquivo para conectar com o banco de dados, que chamaremos <code>db_connection.php</code>, dentro de uma pasta chamada <code>config/</code> com o seguinte conteúdo:</p>
<pre><code class="language-php"><div><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">// arquivo config/db_conneciton.php</span>

$host = <span class="hljs-string">"localhost"</span>;
$username = <span class="hljs-string">"root"</span>;
$passwd = <span class="hljs-string">""</span>;
$dbname = <span class="hljs-string">"des_loja"</span>;
$port = <span class="hljs-string">"3306"</span>;

<span class="hljs-comment">/**
 * Inicia sem nenhuma conexão
 */</span>
$conn = <span class="hljs-keyword">null</span>;

<span class="hljs-comment">/**
  * A função `get_connection` retorna uma conexão ativa com o banco de dados.
  * Se a conexão for igual a null, isto é, a conexão não estiver ativa, então
  * cria uma nova conexão, caso contrário, retorna a conexão que já está ativa.
  * Isto é importante para que não sejam criadas múltiplas conexões ao banco 
  * de dados para cada usuário que acessa o sistema.  
  *
  * <span class="hljs-doctag">@return</span> mysqli uma conexão com o banco de dados
  */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_connection</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">// Para acessar e alterar variáveis fora da função usamos a diretiva `global`</span>
    <span class="hljs-keyword">global</span> $conn, $host, $username, $passwd, $dbname, $post, $port;
    
    <span class="hljs-keyword">if</span> ( !is_resource($conn) ){
        $conn = mysqli_connect($host, $username, $passwd, $dbname, $port);
        $conn-&gt;set_charset(<span class="hljs-string">"utf8"</span>);        
    }
    <span class="hljs-keyword">return</span> $conn;    
}

<span class="hljs-meta">?&gt;</span>
</div></code></pre>
<p>Para verificar se a nossa conexão com o banco de dados funciona vamos desenvolver um arquivo de teste para essa conexão. Chamaremos esse arquivo de <code>test_connection.php</code>, vamos criar ele dentro da pasta <code>config/</code>, com o seguinte conteúdo:</p>
<pre><code class="language-php"><div><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// arquivo /config/test_connection.php</span>

<span class="hljs-keyword">include</span>(<span class="hljs-string">'db_connection.php'</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-string">'Abrindo a conexão.&lt;br&gt;'</span>;
$conn = get_connection();
<span class="hljs-keyword">echo</span> <span class="hljs-string">'Conexão realizada com sucesso.&lt;br&gt;'</span>;

<span class="hljs-keyword">echo</span> <span class="hljs-string">'Fechando a conexão.&lt;br&gt;'</span>;
$conn-&gt;close();
<span class="hljs-keyword">echo</span> <span class="hljs-string">'Conexão fechada.'</span>;
<span class="hljs-meta">?&gt;</span>
</div></code></pre>
<p>Se a conexão estiver funcionando corretamente então o resultado esperado ao acessar a página <code>/config/test_connection.php</code> será o seguinte:</p>
<div style="border: 1px dashed black; padding: 5px;">
Abrindo a conexão.<br>
Conexão realizada com sucesso.<br>
Fechando a conexão.<br>
Conexão fechada.
</div>
<h3 id="fun%c3%a7%c3%a3o-all">Função all</h3>
<p>Com essa conexão funcionando podemos iniciar a criação das nossas funções de DAO. Para isso criamos o arquivo <code>produto_dao.php</code> no diretório raiz da nossa aplicacação. Nesse arquivo vamos implementar nossa primeira função, chamada <code>all()</code>. Esta função vai retornar os dados de todos os produtos na base de dados.</p>
<pre><code class="language-php"><div><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">// arquivo produto_dao.php</span>

<span class="hljs-keyword">include_once</span>(<span class="hljs-string">"config/db_connection.php"</span>); 

<span class="hljs-comment">/**
 * A função all() retorna todos os produtos encontrados
 * na tabela produto da base de dados.
 * 
 * <span class="hljs-doctag">@return</span> array que contém os produtos e seus dados
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">all</span><span class="hljs-params">()</span></span>{
    $conn = get_connection();
    $sql = <span class="hljs-string">'SELECT id, titulo, descricao, preco FROM produto'</span>;
    $stmt = $conn-&gt;prepare($sql);
    $stmt-&gt;execute();
    $instances = [];
    $result = $stmt-&gt;get_result();
    <span class="hljs-keyword">while</span> ($row = $result-&gt;fetch_assoc())
        $instances[] = $row;
    $stmt-&gt;close();    
    $conn-&gt;close();
    <span class="hljs-keyword">return</span> $instances;
}

<span class="hljs-meta">?&gt;</span>
</div></code></pre>
<p>Para verificar que essa funcionalidade esteja funcionando corretamente vamos criar um arquivo de teste. Os testes do <code>DAO</code> vamos armazená-los em uma pasta, chamada <code>testes_dao/</code>. Dentro dela criamos o nosso primeiro teste <code>DAO</code> chamado <code>testes_dao/produto_dao_all.php</code>. Esse arquivo terá o seguinte conteúdo.</p>
<pre><code class="language-php"><div><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">// arquivo testes_dao/produto_dao_all.php</span>

<span class="hljs-keyword">include</span>(<span class="hljs-string">'../produto_dao.php'</span>);

$produtos = all();

<span class="hljs-keyword">if</span> (!$produtos){
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"A consulta não retornou nenhum produto."</span>;
    <span class="hljs-keyword">exit</span>;    
} 

<span class="hljs-meta">?&gt;</span>

&lt;p&gt;Lista de produtos no banco de dados:&lt;/p&gt;
&lt;ul&gt;
<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">foreach</span> ( $produtos <span class="hljs-keyword">as</span> $produto ) { <span class="hljs-meta">?&gt;</span>
    &lt;li&gt;<span class="hljs-meta">&lt;?</span>= implode($produto, <span class="hljs-string">';'</span>)<span class="hljs-meta">?&gt;</span>&lt;/li&gt;
<span class="hljs-meta">&lt;?php</span> } <span class="hljs-meta">?&gt;</span>
&lt;/ul&gt;
</div></code></pre>
<p>Ao executar este teste, se o mesmo funcionar corretamente, o resultado esperado é o seguinte:</p>
<div style="border: 1px dashed black; padding: 5px;">
<p>Lista de produtos no banco de dados:</p>
<ul>
    <li>1;Kit 4 pares de meias;Essas meias proporcionam conforto e proteção para os pés no dia a dia e durante suas atividades físicas;20</li>
    <li>2;Camiseta de Algodão;Em tecido de algodão de alta qualidade, a camiseta básica tem ótimo conforto, é indicada para o dia a dia, ou seja, para usar em casa, trabalho ou lazer.;80</li>
    <li>3;Boné;Este boné tem muito estilo.;15</li>
</ul>
</div>
<h3 id="fun%c3%a7%c3%a3o-create">Função create</h3>
<p>A segunda funcionalidade e DAO que vamos implementar é o <code>create</code>. Esta função recebe como parâmetro os dados de um produto e tem como objetivo inserir o produto como um registro na base de dados, especificamente na tabela <code>produto</code>. No mesmo arquivo <code>produto_dao</code> onde implementamos a função <code>all</code> logo abaixo implementaremos a função <code>create</code>. A nova funcionalidade está implementada a seguir:</p>
<pre><code class="language-php"><div><span class="hljs-meta">&lt;?php</span>  <span class="hljs-comment">// ... continuando o arquivo produto_dao.php</span>

<span class="hljs-comment">/**
 * A função create($produto) recebe os dados de um produto e insere um registro
 * na tabela `produto` da base de dados.
 * 
 * <span class="hljs-doctag">@param</span> array um produto na forma de array no formato chave =&gt; valor.
 * 
 * <span class="hljs-doctag">@return</span> 
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">($produto)</span></span>{        
    $conn = get_connection();
    $sql = <span class="hljs-string">'INSERT INTO produto (titulo, descricao, preco) VALUES (?,?,?)'</span>;    
    $stmt = $conn-&gt;prepare($sql);    
    $stmt-&gt;bind_param(
        <span class="hljs-string">"ssd"</span>, 
        $produto[<span class="hljs-string">'titulo'</span>], 
        $produto[<span class="hljs-string">'descricao'</span>], 
        $produto[<span class="hljs-string">'preco'</span>]);    
    $stmt-&gt;execute();
    $result = $stmt-&gt;get_result();
    $stmt-&gt;close();
    $conn-&gt;close();
    <span class="hljs-keyword">return</span> $result;
}
<span class="hljs-meta">?&gt;</span>
</div></code></pre>
<p>Após isso, vamos criar um novo programa de teste para testar essa funcionalidade. O arquivo <code>testes_dao/produto_dao_create.php</code> tem o seguinte conteúdo:</p>
<pre><code class="language-html"><div>// arquivo testes_dao/produto_dao_create.php`

<span class="php"><span class="hljs-meta">&lt;?php</span> 

$novo_produto = [
    <span class="hljs-string">'titulo'</span> =&gt; <span class="hljs-string">'Coleção Livros do Harry Potter'</span>,
    <span class="hljs-string">'descricao'</span> =&gt; <span class="hljs-string">'É uma coleção muito legal'</span>,
    <span class="hljs-string">'preco'</span> =&gt; <span class="hljs-string">'300.00'</span>
    ];

<span class="hljs-keyword">include</span>(<span class="hljs-string">'../produto_dao.php'</span>);

create($novo_produto);

$produtos = all();

<span class="hljs-meta">?&gt;</span></span>

<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Lista de produtos no banco de dados:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
<span class="php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">foreach</span> ( $produtos <span class="hljs-keyword">as</span> $produto ) { <span class="hljs-meta">?&gt;</span></span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="php"><span class="hljs-meta">&lt;?</span>= implode($produto, <span class="hljs-string">';'</span>)<span class="hljs-meta">?&gt;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="php"><span class="hljs-meta">&lt;?php</span> } <span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</div></code></pre>
<p>O resultado esperado será a lista de produtos, a qual contém o novo produto adicionado, como segue.</p>
<div style="border: 1px dashed black; padding: 5px;">
<p>Lista de produtos no banco de dados:</p>
<ul>
    <li>1;Kit 4 pares de meias;Essas meias proporcionam conforto e proteção para os pés no dia a dia e durante suas atividades físicas;20</li>
    <li>2;Camiseta de Algodão;Em tecido de algodão de alta qualidade, a camiseta básica tem ótimo conforto, é indicada para o dia a dia, ou seja, para usar em casa, trabalho ou lazer.;80</li>
    <li>3;Boné;Este boné tem muito estilo.;15</li>
    <li>4;Coleção Livros do Harry Potter;É uma coleção muito legal;300</li>
</ul>
</div>

    </body>
    </html>